import os.path
import sys
sys.path.append("../tools")
sys.path.append("../tools")

from asm import assembleFile
from link import linkFiles
from natrix import compileNatrix

# Build tools

def asmBuildFunction(target, source, env):
    return assembleFile(str(source[0]), str(target[0]))

# asmBuilder = Builder(action = 'asm.py -o $TARGET $SOURCE', suffix=".o", src_suffix=[".s", ".asm"], single_source=True, src_builder="Natrix")
asmBuilder = Builder(action=asmBuildFunction, suffix=".o", src_suffix=[".s", ".asm"], single_source=True, src_builder="Natrix")

def natrixBuildFunction(target, source, env):
    return compileNatrix(str(target[0]), str(source[0]), cppArgs=['-Ilib'])

natrixBuilder = Builder(action=natrixBuildFunction, suffix=".s", src_suffix=".na", single_source=True, source_scanner=CScanner)
#natrixBuilder = Builder(action = 'natrix.py --cpp-arg=-Ilib -o $TARGET $SOURCE', suffix=".s", src_suffix=".na", single_source=True, source_scanner=CScanner)
def linkGenerator(source, target, env, for_signature):
    return f"link.py -m {target[1]} -o {target[0]} {' '.join(str(s) for s in source)}"

def linkBuildFunction(target, source, env):
    return linkFiles(str(target[0]), [str(s) for s in source], mapfile=str(target[1]))

def linkEmitter(target, source, env):
    t = target[0]
    base,ext = os.path.splitext(str(t))
    target.append(f"{base}.map")
    return target, source

linkBuilder = Builder(action=linkBuildFunction, suffix=".bin", src_suffix=".o", src_builder="Asm", emitter=linkEmitter)
# linkBuilder = Builder(generator=linkGenerator, suffix=".bin", src_suffix=".o", src_builder="Asm", emitter=linkEmitter)
env = Environment(BUILDERS = {'Asm' : asmBuilder, 'Natrix': natrixBuilder, 'Bin': linkBuilder})
env.PrependENVPath("PATH", "../tools")
env["NATRIX_DIR"] = "../tools/natrix"
env["CPPPATH"] = "lib" # needed for scanner

env.Command('lib/keymap.s', ['lib/keymap.py', 'lib/ps2keyboard.h'], './lib/keymap.py lib/ps2keyboard.h lib/keymap.s')

# Libraries
bcdf = Split('''
    lib/bcdf.asm lib/bcdf_addsub.asm lib/bcdf_mul.asm lib/bcdf_div.asm lib/bcdf_print.asm
    ''')
natrix = ['$NATRIX_DIR/runtime/natrix_runtime.asm']

ps2 = Split('lib/ps2.na lib/ps2keyboard.na lib/keymap.s')

vga = Split('''
    lib/vga.asm
    lib/vga_console.na
    ''')

keyboard = ['lib/keyboard.asm']

lib = bcdf + vga + ps2 + keyboard + Split('''
    lib/string.na
    lib/entropy.na
    lib/random.na
    lib/more.na
    lib/line_edit.na
    ''')

# Apps
maze = Split('maze/main.na maze/game.na maze/maze.na')
life = Split('life/quasipixel.na life/life.na life/life_next.asm life/qp_render.asm')
calc = Split('calc/calc.asm')

# Targets
env.Bin('main', Split('''
    main.na
    test/trap.asm
    vga_demo.asm
    matrix.na''') + lib + natrix + maze + life + calc)

env.Bin('alutest', 'test/alutest.asm')

env.Bin('memcheck', 'memcheck/memcheck.asm')

env.Bin('lotest', Split('memcheck/lotest.na') + natrix + lib)

env.Bin('vgatest', Split('test/vgatest.na') + natrix + lib)

env.Bin('ps2test', Split('test/ps2test.na') + natrix + lib)

env.Bin('ps2hightest', Split('test/ps2hightest.na') + natrix + lib)

env.Bin('cardtest', Split('test/cardtest.na lib/card.na lib/fat.na') + natrix + lib)
